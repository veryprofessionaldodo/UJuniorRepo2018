pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

function _init()
 t=0

 nave  = {
  sp=1,
  x=60,
  y=100,
  h=4,
  p=0,
  t=0,
  imm=false,
  box = {x1=0,y1=0,x2=7,y2=7}}
 bullets = {}
 enemies = {}
 explosions = {}
 for i=1,6 do
 add(enemies, {
  sp=17,
  m_x=i*16,
  m_y=60-i*8,
  x=-32,
  y=-32,
  r=12,
  box = {x1=0,y1=0,x2=7,y2=7}
 })
 end
 start()
end

function coll(a,b)
 --todo
 local box_a= abs_box(a)
 local box_b= abs_box(b)

if box_a.x1 > box_b.x2 or
   box_a.y1 > box_b.y2 or
   box_b.x1 > box_a.x2 or
   box_b.y1 > box_a.y2 then
   return false
end
  
  return true
end

function start()
 _update = update_game
 _draw = draw_game
end

function game_over()
 _update = update_over
 _draw = draw_over
end

function update_over()

end

function draw_over()
 cls()
 print("game over",50,50,4)
end  
 function abs_box(s)
 local box = {}
 box.x1 = s.box.x1 + s.x
 box.y1 = s.box.y1 + s.y
 box.x2 = s.box.x2 + s.x
 box.y2 = s.box.y2 + s.y
 return box 
end

function explode(x,y)
 add(explosions,{x=x,y=y,t=0})

end

function fire()
 local b = {
  sp=3,
  x=nave.x,
  y=nave.y,
  dx=0,
  dy=-3,
  box = {x1=2,y1=0,x2=5,y2=4}
  }
 add(bullets,b)

end
 
function update_game()
 t=t+1
 if nave.imm then
  nave.t +=1
  if nave.t >30 then
   nave.imm = false
   nave.t = 0 
  end
 end
  
 for ex in all(explosions) do
  ex.t+=1
  if ex.t==13 then
   del(explosions, ex)
   end
 end
 for e in all(enemies) do
  e.x = e.r*sin(t/50) + e.m_x
  e.y = e.r*cos(t/50) + e.m_x
  if coll(nave,e) and not nave.imm then
   nave.imm = true
   nave.h-=1
   if nave.h <= 0 then
    game_over()
   end
  end
 end
 
 for b in all(bullets) do
  b.x+=b.dx
  b.y+=b.dy
  if b.x < 0 or b.x > 128 or
   b.y < 0 or b.y > 128 then
   del(bullets,b)
  end
  for e in all(enemies)do
   if coll(b,e) then
    del(enemies,e)
    nave.p += 1
    end
   end
  end

 if(t%8<4) then
  nave.sp=1
 else
  nave.sp=2
 end

 if btn(0) then nave.x-=1 end
 if btn(1) then nave.x+=1 end
 if btn(2) then nave.y-=1 end
 if btn(3) then nave.y+=1 end
 if btnp(4) then fire() end
end

function draw_game()
 cls()
 print(nave.p,9)
 if not nave.imm or t%8 < 4 then
 spr(nave.sp,nave.x,nave.y)
 end
	for b in all(bullets) do
 spr(b.sp,b.x,b.y)
 end
 
 for e  in all(enemies) do
  spr(e.sp,e.x,e.y)
	end
 
 for i=1,4 do
  if i<=nave.h then
  spr(33,80+6*i,3)
  else
  spr(34,80+6*i,3)
  end
 end
end


__gfx__
000000000090090000a00a00000cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000b00b0000600600000aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000b88b0000699600000cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000b88b000069960000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000cb88bc00869968000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000cb0abc0086a068000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000090a00900a00a0a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000a0bb0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000b8bb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000bbb77b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000b8b70b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000bbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000a0b80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000080800000606000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000888880006666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088800000666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000008000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
